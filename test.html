<html>
<script type="text/javascript" src="jquery-1.5.min.js"></script>
Chrome Speech Search and TTS Example<br><br>
<form id="searchform">
<input type="text" name="search" x-webkit-speech=true onwebkitspeechchange='searchBKS();'>
</form>

<div class="latestBooks"></div><br>
<div class="redirectFlag"></div><br>
<div class="synopsys"></div><br>

<script language="JavaScript">

var apiKey = ''; // get your API key from http://developer.bookshare.org by creating an account and then obtaining an PAPI key
var i = 0;
var introMsg = "This app enables voice search and uses TTS to speak the search results.  After you hear the title and author of a book, you can hit any key to retrieve the synopsys of a book.";

function speak() {
    if ($('div.redirectFlag').text() != "") {
		  var lastBook = i-1;
		  var redirectMsg = "Retrieving synopsys for " + books[lastBook].title + " by " + books[lastBook].author;
		  $('div.redirectFlag').text(redirectMsg);
		  // chrome.experimental.tts.speak(redirectMsg,{'rate': 1},function(){
		  showSynopsys(books[lastBook].id);
		  // window.location = "http://www.bookshare.org/browse/book/" + books[lastBook].id;
      //});
    }
    else {
		if (i++ < books.length) {
			$('div.latestBooks').html("<a href='http://www.bookshare.org/browse/book/" + books[i].id + "'>" + books[i].title +" by " + books[i].author + "</a><br>");
			chrome.experimental.tts.speak(books[i].title + " by " + books[i].author,{'rate': 1},function(){speak();});
		}
	}
}

function showSynopsys(bookID) {
var jqxhr = $.getJSON('http://api.bookshare.org/book/id/' + bookID + '/format/json?api_key=' + apiKey, function(json) {
	synopsis = json.bookshare.book.metadata["brief-synopsis"];
	$('div.synopsys').text(synopsis);
	
//var elem = document.getElementById("synopsys");
//var sentence = elem.innerHTML;
//chrome.experimental.tts.speak(sentence, {}, function(event){
//
            //determine next word to highlight since the tts only returns the index of the word just spoken
//            var currSentence = sentence.substr(event.charIndex, sentence.length);
//            var words = currSentence.split(/\s/);

            //determine location of next word in the sentence
//            var range = document.createRange();
//            range.setStart(elem.firstChild, event.charIndex);
//            range.setEnd(elem.firstChild, event.charIndex + words[0].length);

            // unhighlight last word and highlight next word
//            window.getSelection().removeAllRanges();
//            window.getSelection().addRange(range);
//});	

});
}

$('div.latestBooks').html(introMsg + "<br>");

$(document).keypress(function() {
	$('div.redirectFlag').text("Redirecting...");
	chrome.experimental.tts.stop();
});

function searchBKS() {
var jqxhr = $.getJSON('http://api.bookshare.org/book/search/' + encodeURI($('#searchform input[name="search"]').val()) + '/format/json?api_key=' + apiKey, function(json) {
   chrome.experimental.tts.speak(introMsg,{'rate': 0.8},function() {
	books = json.bookshare.book.list.results;
	speak();
	});
 });
 }
 
</script>
</html>